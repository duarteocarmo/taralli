<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      src="https://unpkg.com/htmx.org@2.0.4"
      integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
      crossorigin="anonymous"
    ></script>

    <title>Taralli</title>
    <style>
      body {
        font-family: monospace;
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
        line-height: 1.6;
        background: #fff;
        color: #333;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 40px;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
      }

      .input-section {
        margin: 30px 0;
        padding: 20px;
        border: 2px solid #333;
      }

      input,
      button {
        font-family: monospace;
        font-size: 1em;
        padding: 5px;
        margin: 5px;
      }

      button {
        background: #333;
        color: #fff;
        border: none;
        padding: 8px 16px;
        cursor: pointer;
      }

      button:hover {
        background: #555;
      }

      .charts {
        display: flex;
        gap: 20px;
        margin-top: 40px;
      }

      .chart {
        flex: 1;
        border: 2px solid #333;
        padding: 20px;
      }

      .chart-title {
        font-size: 1.2em;
        margin-bottom: 15px;
        text-align: center;
      }

      .bar-chart {
        display: flex;
        align-items: flex-end;
        height: 200px;
        gap: 4px;
      }

      .bar {
        flex: 1;
        background: #333;
        min-width: 20px;
        transition: height 0.3s ease;
      }

      .date-labels {
        display: flex;
        gap: 4px;
        margin-top: 5px;
        font-size: 0.8em;
      }

      .date-label {
        flex: 1;
        text-align: center;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        height: 40px;
      }

      .input-section textarea {
        font-family: monospace;
        font-size: 1em;
        padding: 8px;
        margin: 5px;
        width: calc(100% - 16px);
        height: 60px;
        resize: vertical;
      }

      .date-hint {
        font-size: 0.8em;
        color: #666;
        margin-top: 5px;
      }

      .recent-logs {
        margin-top: 40px;
        border: 2px solid #333;
        padding: 20px;
      }

      .log-entry {
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .log-date {
        color: #666;
        font-size: 0.9em;
      }

      .log-type {
        display: inline-block;
        padding: 2px 6px;
        background: #333;
        color: #fff;
        font-size: 0.8em;
        margin-right: 8px;
      }
    </style>
  </head>
  <body hx-boost="true">
    <h1>Taralli</h1>

    <div class="input-section">
      <form action="/log/weight" method="post" hx-push-url="false">
        <div class="input-group">
          <input
            type="number"
            step="0.1"
            id="weight"
            placeholder="Weight (kg)"
            name="weight"
          />
          <input type="datetime-local" id="weight-date" name="date" />
          <button type="submit">Log Weight</button>
          <div class="date-hint">
            Date is optional - current time will be used if not specified
          </div>
        </div>
      </form>
      <form action="/log/meal" method="post" hx-push-url="false">
        <div class="input-group">
          <textarea
            id="meal"
            placeholder="Meal description"
            name="description"
          ></textarea>
          <input type="datetime-local" id="meal-date" name="date" />
          <button type="submit">Log Meal</button>
          <div class="date-hint">
            Date is optional - current time will be used if not specified
          </div>
        </div>
      </form>
    </div>

    <div class="charts">
      <div class="chart">
        <div class="chart-title">Weight Progress (14 days)</div>
        <div class="bar-chart" id="weight-chart">
          <!-- Bars will be inserted here -->
        </div>
        <div class="date-labels" id="weight-dates">
          <!-- Dates will be inserted here -->
        </div>
      </div>

      <div class="chart">
        <div class="chart-title">Meals Per Day (14 days)</div>
        <div class="bar-chart" id="meal-chart">
          <!-- Bars will be inserted here -->
        </div>
        <div class="date-labels" id="meal-dates">
          <!-- Dates will be inserted here -->
        </div>
      </div>
    </div>

    <div class="recent-logs">
      <h2>Recent Logs</h2>
      <div id="log-entries">
        {% for entry in log_entries %}
        <div class="log-entry">
          <span class="log-type">{{ entry_name }}</span>
          <span class="log-date"
            >{{ entry.date.strftime('%Y-%m-%d %H:%M:%S') }}</span
          >
          <div>
            {% if entry.__class__.__name__ == 'Weight' %} {{
            "%.1f"|format(entry.weight) }} kg {% else %} {{ entry.description }}
            {% if entry.calories %}({{ entry.calories }} cal){% endif %} {%
            endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    {{ log_entries }}

    <script>
      async function fetchData() {
        try {
          const response = await fetch("/data/all");
          const data = await response.json();

          return {
            weights: data.chart_data.weights.map((w) => w.weight),
            meals: data.chart_data.meals.map((m) => m.count),
          };
        } catch (error) {
          console.error("Error fetching data:", error);
          return {
            weights: Array(14)
              .fill(null)
              .map(() => Math.random() * 20 + 70),
            meals: Array(14)
              .fill(null)
              .map(() => Math.floor(Math.random() * 4) + 1),
          };
        }
      }

      async function updateCharts() {
        const data = await fetchData();
        const weightData = data.weights;
        const mealData = data.meals;

        const weightChart = document.getElementById("weight-chart");
        const mealChart = document.getElementById("meal-chart");
        const weightDates = document.getElementById("weight-dates");
        const mealDates = document.getElementById("meal-dates");

        // Clear existing charts
        weightChart.innerHTML = "";
        mealChart.innerHTML = "";
        weightDates.innerHTML = "";
        mealDates.innerHTML = "";

        // Get date labels
        const dates = Array(14)
          .fill(null)
          .map((_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (13 - i));
            return date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });
          });

        // Create bars and labels
        weightData.forEach((weight, i) => {
          const heightPercent =
            ((weight - Math.min(...weightData)) /
              (Math.max(...weightData) - Math.min(...weightData))) *
            100;

          const weightBar = document.createElement("div");
          weightBar.className = "bar";
          weightBar.style.height = `${heightPercent}%`;
          weightBar.title = `${weight.toFixed(1)} kg`;
          weightChart.appendChild(weightBar);

          const dateLabel = document.createElement("div");
          dateLabel.className = "date-label";
          dateLabel.textContent = dates[i];
          weightDates.appendChild(dateLabel);
        });

        mealData.forEach((meals, i) => {
          const heightPercent = (meals / Math.max(...mealData)) * 100;

          const mealBar = document.createElement("div");
          mealBar.className = "bar";
          mealBar.style.height = `${heightPercent}%`;
          mealBar.title = `${meals} meals`;
          mealChart.appendChild(mealBar);

          const dateLabel = document.createElement("div");
          dateLabel.className = "date-label";
          dateLabel.textContent = dates[i];
          mealDates.appendChild(dateLabel);
        });
      }

      async function logWeight() {
        const weightInput = document.getElementById("weight");
        const dateInput = document.getElementById("weight-date");
        const weight = weightInput.value;
        const date = dateInput.value ? new Date(dateInput.value) : new Date();

        try {
          const response = await fetch("/log/weight", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              weight: parseFloat(weight),
              date: date.toISOString(),
            }),
          });

          if (response.ok) {
            weightInput.value = "";
            dateInput.value = "";
            await updateCharts();
          }
        } catch (error) {
          console.error("Error logging weight:", error);
        }
      }

      async function logMeal() {
        const mealInput = document.getElementById("meal");
        const dateInput = document.getElementById("meal-date");
        const meal = mealInput.value;
        const date = dateInput.value ? new Date(dateInput.value) : new Date();

        try {
          const response = await fetch("/log/meal", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              description: meal,
              date: date.toISOString(),
            }),
          });

          const data = await response.json();
          if (response.ok) {
            mealInput.value = "";
            dateInput.value = "";
            alert(`Meal logged! Estimated calories: ${data.calories}`);
            await updateCharts();
          }
        } catch (error) {
          console.error("Error logging meal:", error);
        }
      }

      // Initialize charts when page loads
      updateCharts();
    </script>
  </body>
</html>
